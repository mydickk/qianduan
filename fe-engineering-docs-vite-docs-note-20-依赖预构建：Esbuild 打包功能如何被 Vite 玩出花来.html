<!DOCTYPE html> <html lang="en-US"><!--
 Page saved with SingleFile 
 url: https://interview2.poetries.top/fe-engineering-docs/vite-docs/note/20-依赖预构建：Esbuild 打包功能如何被 Vite 玩出花来.html 
 saved date: Thu Aug 25 2022 06:40:24 GMT+0800 (China Standard Time)
--><head>
      <style type="text/css">
        @media screen and (min-width:850px){
          .sidebar-button{
            display: none
          }
          .sidebar{
            transform: translateX(0);
          }
        }
        @media screen and (max-width:850px){
          .sidebar-button{
            display: block
          }
        }
      </style>
      <script>
      document.onreadystatechange=function() {
        if(document.readyState == "complete"){ //当页面加载状态为完全结束时进入
          const sidebar = document.querySelector(".sidebar");
          document.querySelector(".sidebar-button").addEventListener("click", (e) => {
            if (!sidebar.style.transform || sidebar.style.transform === "translateX(-100%)") {
              sidebar.style.transform = "translateX(0)";
            } else {
              sidebar.style.transform = "translateX(-100%)";
            }
          });
          var throttle = function (func, delay) {
            var prev = Date.now();
            return function () {
              var context = this; //this指向window
              var args = arguments;
              var now = Date.now();
              if (now - prev >= delay) {
                func.apply(context, args);
                prev = Date.now();
              }
            };
          };
          window.onresize = throttle(function () {
            if (window.innerWidth > 850) {
              if (!sidebar.style.transform || sidebar.style.transform === "translateX(-100%)") {
                sidebar.style.transform = "translateX(0)";
              }
            }
          }, 1000);
        }
      }
      </script><meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端工程相关</title>
    
    
  
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style">
  
    
    
    <style>svg[data-v-49140617]{position:absolute;right:7.5px;cursor:pointer}svg.hover[data-v-49140617]{opacity:0}svg[data-v-49140617]:hover{opacity:1!important}span[data-v-49140617]{position:absolute;font-size:.85rem;line-height:.425rem;right:50px;opacity:0;-webkit-transition:opacity .5s;transition:opacity .5s}.code-copy-added:hover>.code-copy svg{opacity:.75}@-webkit-keyframes rotating{0%{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes rotating{0%{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@-webkit-keyframes v-modal-in{0%{opacity:0}}@-webkit-keyframes v-modal-out{to{opacity:0}}.el-dialog__wrapper{position:fixed;top:0;right:0;bottom:0;left:0;overflow:auto;margin:0}@-webkit-keyframes dialog-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@keyframes dialog-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@-webkit-keyframes dialog-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@keyframes dialog-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@keyframes v-modal-in{0%{opacity:0}}@keyframes v-modal-out{to{opacity:0}}@-webkit-keyframes msgbox-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@keyframes msgbox-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@-webkit-keyframes msgbox-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@keyframes msgbox-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@-webkit-keyframes slideInRight-enter{0%{opacity:0;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(100%);transform:translateX(100%)}to{opacity:1;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0)}}@keyframes slideInRight-enter{0%{opacity:0;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(100%);transform:translateX(100%)}to{opacity:1;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0)}}@-webkit-keyframes slideInRight-leave{0%{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0);opacity:1}to{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(100%);transform:translateX(100%);opacity:0}}@keyframes slideInRight-leave{0%{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0);opacity:1}to{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(100%);transform:translateX(100%);opacity:0}}@-webkit-keyframes slideInLeft-enter{0%{opacity:0;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(-100%);transform:translateX(-100%)}to{opacity:1;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0)}}@keyframes slideInLeft-enter{0%{opacity:0;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(-100%);transform:translateX(-100%)}to{opacity:1;-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0)}}@-webkit-keyframes slideInLeft-leave{0%{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0);opacity:1}to{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(-100%);transform:translateX(-100%);opacity:0}}@keyframes slideInLeft-leave{0%{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(0);transform:translateX(0);opacity:1}to{-webkit-transform-origin:0 0;transform-origin:0 0;-webkit-transform:translateX(-100%);transform:translateX(-100%);opacity:0}}@-webkit-keyframes loading-rotate{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes loading-rotate{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@-webkit-keyframes loading-dash{0%{stroke-dasharray:1,200;stroke-dashoffset:0}50%{stroke-dasharray:90,150;stroke-dashoffset:-40px}to{stroke-dasharray:90,150;stroke-dashoffset:-120px}}@keyframes loading-dash{0%{stroke-dasharray:1,200;stroke-dashoffset:0}50%{stroke-dasharray:90,150;stroke-dashoffset:-40px}to{stroke-dasharray:90,150;stroke-dashoffset:-120px}}@-webkit-keyframes progress{0%{background-position:0 0}to{background-position:32px 0}}@keyframes progress{0%{background-position:0 0}to{background-position:32px 0}}@-webkit-keyframes rotate{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes rotate{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@-webkit-keyframes dash{0%{stroke-dasharray:1,150;stroke-dashoffset:0}50%{stroke-dasharray:90,150;stroke-dashoffset:-35}to{stroke-dasharray:90,150;stroke-dashoffset:-124}}@keyframes dash{0%{stroke-dasharray:1,150;stroke-dashoffset:0}50%{stroke-dasharray:90,150;stroke-dashoffset:-35}to{stroke-dasharray:90,150;stroke-dashoffset:-124}}@-webkit-keyframes viewer-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@keyframes viewer-fade-in{0%{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}to{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}}@-webkit-keyframes viewer-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@keyframes viewer-fade-out{0%{-webkit-transform:translateZ(0);transform:translateZ(0);opacity:1}to{-webkit-transform:translate3d(0,-20px,0);transform:translate3d(0,-20px,0);opacity:0}}@-webkit-keyframes el-drawer-fade-in{0%{opacity:0}to{opacity:1}}@keyframes el-drawer-fade-in{0%{opacity:0}to{opacity:1}}@-webkit-keyframes rtl-drawer-in{0%{-webkit-transform:translate(100%);transform:translate(100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@keyframes rtl-drawer-in{0%{-webkit-transform:translate(100%);transform:translate(100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@-webkit-keyframes rtl-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translate(100%);transform:translate(100%)}}@keyframes rtl-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translate(100%);transform:translate(100%)}}@-webkit-keyframes ltr-drawer-in{0%{-webkit-transform:translate(-100%);transform:translate(-100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@keyframes ltr-drawer-in{0%{-webkit-transform:translate(-100%);transform:translate(-100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@-webkit-keyframes ltr-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translate(-100%);transform:translate(-100%)}}@keyframes ltr-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translate(-100%);transform:translate(-100%)}}@-webkit-keyframes ttb-drawer-in{0%{-webkit-transform:translateY(-100%);transform:translateY(-100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@keyframes ttb-drawer-in{0%{-webkit-transform:translateY(-100%);transform:translateY(-100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@-webkit-keyframes ttb-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translateY(-100%);transform:translateY(-100%)}}@keyframes ttb-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translateY(-100%);transform:translateY(-100%)}}@-webkit-keyframes btt-drawer-in{0%{-webkit-transform:translateY(100%);transform:translateY(100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@keyframes btt-drawer-in{0%{-webkit-transform:translateY(100%);transform:translateY(100%)}to{-webkit-transform:translate(0);transform:translate(0)}}@-webkit-keyframes btt-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translateY(100%);transform:translateY(100%)}}@keyframes btt-drawer-out{0%{-webkit-transform:translate(0);transform:translate(0)}to{-webkit-transform:translateY(100%);transform:translateY(100%)}}@-webkit-keyframes nprogress-spinner{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes nprogress-spinner{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}.icon.outbound{color:#aaa;display:inline-block;vertical-align:middle;position:relative;top:-1px}.nav-links{display:inline-block}.nav-links a{line-height:1.4rem;color:inherit}.nav-links a.router-link-active,.nav-links a:hover{color:#3eaf7c}.nav-links .nav-item{position:relative;display:inline-block;margin-left:1.5rem;line-height:2rem}.nav-links .nav-item:first-child{margin-left:0}@media (max-width:850px){.nav-links .nav-item{margin-left:0}}@media (min-width:850px){.nav-links a.router-link-active,.nav-links a:hover{color:#2c3e50}}.navbar{padding:.7rem 1.5rem;line-height:2.2rem}.navbar a{display:inline-block}.navbar .links{padding-left:1.5rem;box-sizing:border-box;background-color:#fff;white-space:nowrap;font-size:.9rem;position:absolute;right:1.5rem;top:.7rem;display:-webkit-box;display:flex}@media (max-width:850px){.navbar{padding-left:4rem}.navbar .can-hide{display:none}.navbar .links{padding-left:1.5rem}}.page-nav{max-width:740px;margin:0 auto;padding:2rem 2.5rem}@media (max-width:959px){.page-nav{padding:2rem}}@media (max-width:419px){.page-nav{padding:1.5rem}}.page-nav{padding-top:1rem;padding-bottom:0}.page-nav .inner{min-height:2rem;margin-top:0;border-top:1px solid #eaecef;padding-top:1rem;overflow:auto}.page-nav .next{float:right}.page{padding-bottom:2rem;overflow-x:hidden;display:block}@media only screen and (min-device-width:768px) and (max-device-width:1024px){.page{padding-bottom:20rem!important}}@media screen and (min-width:1200px){.theme-default-content:not(.custom){max-width:1300px!important}}.theme-default-content .content__default{position:relative}.theme-default-content .content__default pre{position:relative!important;padding-top:40px!important}.theme-default-content .content__default pre:after{content:"";position:absolute;top:9px;left:12px;z-index:1;width:10px;height:10px;border-radius:50%;background:#fc625d;box-shadow:20px 0#fdbc40,40px 0#35cd4b}@media screen and (min-width:700px){.theme-default-content .content__default h2{display:-webkit-inline-box;display:inline-flex;-webkit-box-align:center;align-items:center;font-weight:700;background:#ef7060;color:#fff;padding:3px 10px 4px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px;font-size:20px}.theme-default-content .content__default h2:after{content:"";display:inline-block;vertical-align:bottom;border-bottom:36px solid #efebe9;border-right:20px solid transparent;position:relative;left:32px;top:1px}.theme-default-content .content__default h2:before{content:"";border-bottom:2px solid #ef7060;width:100%;display:block;height:10px;position:absolute;margin-top:32px}}.theme-default-content .content__default code{color:#c7254e;background-color:#f9f2f4;font-size:14px;border-radius:5px;padding-left:5px;padding-right:5px;margin:auto 3px}.theme-default-content .content__default blockquote{padding:2px 16px;color:#555;border-left:5px solid #ef7060;background:#fff9f9;font-size:1rem}@-webkit-keyframes upDown{0%{-webkit-transform:translateY(5px);transform:translateY(5px)}25%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(5px);transform:translateY(5px)}75%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(5px);transform:translateY(5px)}}@keyframes upDown{0%{-webkit-transform:translateY(5px);transform:translateY(5px)}25%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(5px);transform:translateY(5px)}75%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(5px);transform:translateY(5px)}}.sidebar-group:not(.collapsable) .sidebar-heading:not(.clickable){cursor:auto;color:inherit}.sidebar-heading{-webkit-transition:color .15s ease;transition:color .15s ease;cursor:pointer;font-size:1.1em;font-weight:700;padding:.35rem 1.5rem .35rem 1.25rem;width:100%;box-sizing:border-box;margin:0;border-left:.25rem solid transparent}.sidebar-heading.open,.sidebar-heading:hover{color:inherit}.sidebar-group-items{-webkit-transition:height .1s ease-out;transition:height .1s ease-out;font-size:.95em;overflow:hidden}.sidebar .sidebar-sub-headers{padding-left:1rem;font-size:.95em}a.sidebar-link{font-size:1em;font-weight:400;color:#2c3e50;border-left:.25rem solid transparent;padding:.35rem 1rem .35rem 1.25rem;line-height:1.4;width:100%;box-sizing:border-box}a.sidebar-link:hover{color:#3eaf7c}a.sidebar-link.active{font-weight:600;color:#3eaf7c;border-left-color:#3eaf7c}.sidebar-group a.sidebar-link{padding-left:2rem}.sidebar-sub-headers a.sidebar-link{padding-top:.25rem;padding-bottom:.25rem;border-left:none}.sidebar-sub-headers a.sidebar-link.active{font-weight:500}.sidebar ul{padding:0;margin:0;list-style-type:none}.sidebar a{display:inline-block}.sidebar>.sidebar-links{padding:1.5rem 0}.sidebar>.sidebar-links>li:not(:first-child){margin-top:.75rem}@media (max-width:850px){.sidebar>.sidebar-links{padding:1rem 0}}@-webkit-keyframes move{0%{-webkit-transform:translate(-175px) scale(1);transform:translate(-175px) scale(1)}50%{-webkit-transform:translate(-87px) scaleY(.5);transform:translate(-87px) scaleY(.5)}to{-webkit-transform:translate(0) scale(1);transform:translate(0) scale(1)}}@keyframes move{0%{-webkit-transform:translate(-175px) scale(1);transform:translate(-175px) scale(1)}50%{-webkit-transform:translate(-87px) scaleY(.5);transform:translate(-87px) scaleY(.5)}to{-webkit-transform:translate(0) scale(1);transform:translate(0) scale(1)}}.posr{position:relative}pre[class*=language-]{color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function{color:#f08d49}.token.class-name,.token.constant{color:#f8c555}.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator{color:#67cdcc}.theme-default-content code{padding:.25rem .5rem}.theme-default-content pre[class*=language-]{line-height:1.4;padding:1.25rem 1.5rem;margin:.85rem 0;background-color:#282c34;border-radius:6px;overflow:auto}.theme-default-content pre[class*=language-] code{color:#fff;padding:0;background-color:transparent;border-radius:0}div[class*=language-]{position:relative;background-color:#282c34;border-radius:6px}div[class*=language-] pre[class*=language-]{background:transparent;position:relative;z-index:1}div[class*=language-]:before{position:absolute;z-index:3;top:.8em;right:1em;font-size:.75rem;color:hsla(0,0%,100%,.4)}div[class~=language-js]:before{content:"js"}div[class~=language-ts]:before{content:"ts"}.theme-default-content:not(.custom){max-width:740px;margin:0 auto;padding:2rem 2.5rem}@media (max-width:959px){.theme-default-content:not(.custom){padding:2rem}}@media (max-width:419px){.theme-default-content:not(.custom){padding:1.5rem}}body,html{padding:0;margin:0;background-color:#fff}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:16px;color:#2c3e50}.page{padding-left:20rem}.navbar{z-index:20;right:0;height:3.6rem;background-color:#fff;box-sizing:border-box;border-bottom:1px solid #eaecef}.navbar{position:fixed;top:0;left:0}.sidebar{font-size:16px;background-color:#fff;width:20rem;position:fixed;z-index:10;margin:0;top:3.6rem;left:0;bottom:0;box-sizing:border-box;border-right:1px solid #eaecef;overflow-y:auto}.theme-default-content:not(.custom)>:first-child{margin-top:3.6rem}.theme-default-content:not(.custom) a:hover{text-decoration:underline}a{font-weight:500;text-decoration:none}a{color:#3eaf7c}blockquote{margin:1rem 0}blockquote>p{margin:0}ol,ul{padding-left:1.2em}strong{font-weight:600}h2,h3,h4{font-weight:600;line-height:1.25}h1:hover .header-anchor,h2:hover .header-anchor,h3:hover .header-anchor,h4:hover .header-anchor,h5:hover .header-anchor,h6:hover .header-anchor{opacity:1}h2{font-size:1.65rem;padding-bottom:.3rem;border-bottom:1px solid #eaecef}h3{font-size:1.35rem}a.header-anchor{font-size:.85em;float:left;margin-left:-.87em;padding-right:.23em;margin-top:.125em;opacity:0}a.header-anchor:hover{text-decoration:none}code{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}ol,p,ul{line-height:1.7}@media (max-width:959px){.sidebar{font-size:15px;width:16.4rem}.page{padding-left:16.4rem}}@media (max-width:850px){.sidebar{top:0;padding-top:3.6rem;transform:translateX(-100%);transition:transform .2s ease}.page{padding-left:0}}@media (max-width:419px){.theme-default-content div[class*=language-]{margin:.85rem -1.5rem;border-radius:0}}</style>
  <style type="text/css"></style><meta name="description" content="前端工程相关"><link rel="icon" href="data:image/png;base64,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"><style>.sf-hidden{display:none!important}</style><link rel="canonical" href="https://interview2.poetries.top/fe-engineering-docs/vite-docs/note/20-依赖预构建：Esbuild 打包功能如何被 Vite 玩出花来.html"><meta http-equiv="content-security-policy" content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
  <body class>
    <div id="app"><div class="theme-container posr"><div><header class="navbar"> 
          <div class="sidebar-button" style="
          width: 1rem;
      "><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div>  <div class="links" style="max-width:1155px"> <nav class="nav-links can-hide"><div class="nav-item"><div><a href="./fe-engineering-docs-docs-npm-script.html" class="nav-link">Npm工作流
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-fe-engineering-note-01-%E5%BC%80%E7%AF%87%E8%AF%8D%20%E4%BB%80%E4%B9%88%E6%98%AF%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B.html" class="nav-link">前端工程化
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-docs-webpack.html" class="nav-link">Webpack
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-docs-docker.html" class="nav-link">Docker
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-babel-docs-note-01-Babel%E7%9A%84%E4%BB%8B%E7%BB%8D.html" class="nav-link">Babel
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-vite-docs-note-01-%E6%A8%A1%E5%9D%97%E6%A0%87%E5%87%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%20ESM%20%E6%98%AF%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9A%84%E6%9C%AA%E6%9D%A5.html" class="nav-link">Vite
  </a></div></div><div class="nav-item"><div><a href="./fe-engineering-docs-ci-docs-note-01-%E4%BB%80%E4%B9%88%E6%98%AF%20CI%20CD.html" class="nav-link">CI/CD 流程
  </a></div></div> <!----></nav> </div></header></div> <div class="sidebar-mask sf-hidden"></div> <aside class="sidebar"><nav class="nav-links sf-hidden"> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="./fe-engineering-docs-vite-docs-note-01-%E6%A8%A1%E5%9D%97%E6%A0%87%E5%87%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%20ESM%20%E6%98%AF%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9A%84%E6%9C%AA%E6%9D%A5.html" class="sidebar-link">模块标准：为什么 ESM 是前端模块化的未来</a></li><li><a href="./fe-engineering-docs-vite-docs-note-02-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B:%20%E5%A6%82%E4%BD%95%E7%94%A8%20Vite%20%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE.html" class="sidebar-link">快速上手: 如何用 Vite 从零搭建前端项目</a></li><li><a href="./fe-engineering-docs-vite-docs-note-03-%E6%A0%B7%E5%BC%8F%E6%96%B9%E6%A1%88%EF%BC%9A%E5%9C%A8%20Vite%20%E4%B8%AD%E6%8E%A5%E5%85%A5%E7%8E%B0%E4%BB%A3%E5%8C%96%E7%9A%84%20CSS%20%E5%B7%A5%E7%A8%8B%E5%8C%96%E6%96%B9%E6%A1%88.html" class="sidebar-link">样式方案：在 Vite 中接入现代化的 CSS 工程化方案</a></li><li><a href="./fe-engineering-docs-vite-docs-note-04-%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83:%20%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8%20Lint%20%E5%B7%A5%E5%85%B7%E9%93%BE%E6%9D%A5%E4%BF%9D%E8%AF%81%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E5%92%8C%E8%B4%A8%E9%87%8F.html" class="sidebar-link">代码规范: 如何利用 Lint 工具链来保证代码风格和质量</a></li><li><a href="./fe-engineering-docs-vite-docs-note-05-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90:%20%E5%A6%82%E4%BD%95%E5%9C%A8%20Vite%20%E4%B8%AD%E5%A4%84%E7%90%86%E5%90%84%E7%A7%8D%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90.html" class="sidebar-link">静态资源: 如何在 Vite 中处理各种静态资源</a></li><li><a href="./fe-engineering-docs-vite-docs-note-06-%E9%A2%84%E6%9E%84%E5%BB%BA:%20%E5%A6%82%E4%BD%95%E7%8E%A9%E8%BD%AC%E7%A7%92%E7%BA%A7%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%BD%E5%8A%9B.html" class="sidebar-link">预构建: 如何玩转秒级依赖预构建的能力</a></li><li><a href="./fe-engineering-docs-vite-docs-note-07-%E5%8F%8C%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84:%20Vite%20%E6%98%AF%E5%A6%82%E4%BD%95%E7%AB%99%E5%9C%A8%E5%B7%A8%E4%BA%BA%E7%9A%84%E8%82%A9%E8%86%80%E4%B8%8A%E5%AE%9E%E7%8E%B0%E7%9A%84.html" class="sidebar-link">双引擎架构: Vite 是如何站在巨人的肩膀上实现的</a></li><li><a href="./fe-engineering-docs-vite-docs-note-08-%E5%BE%97%E5%8A%9B%E7%9A%84%E6%80%A7%E8%83%BD%E6%8E%A8%E6%89%8B:%20Esbuild%20%E5%8A%9F%E8%83%BD%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98.html" class="sidebar-link">得力的性能推手: Esbuild 功能使用与插件开发实战</a></li><li><a href="./fe-engineering-docs-vite-docs-note-09-Vite%20%E6%9E%84%E5%BB%BA%E5%9F%BA%E7%9F%B3%20%E4%B8%8A%20Rollup%20%E6%89%93%E5%8C%85%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E4%BD%BF%E7%94%A8.html" class="sidebar-link">Vite 构建基石 上 Rollup 打包基本概念及使用</a></li><li><a href="./fe-engineering-docs-vite-docs-note-10-Vite%20%E6%9E%84%E5%BB%BA%E5%9F%BA%E7%9F%B3%20%E4%B8%8B%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Rollup%20%E7%9A%84%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6.html" class="sidebar-link">Vite 构建基石 下 深入理解 Rollup 的插件机制</a></li><li><a href="./fe-engineering-docs-vite-docs-note-11-%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%9E%E6%88%98:%20%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%20Vite%20%E6%8F%92%E4%BB%B6.html" class="sidebar-link">插件开发与实战: 如何开发一个完整的 Vite 插件</a></li><li><a href="./fe-engineering-docs-vite-docs-note-12-HMR%20API%20%E5%8F%8A%E5%8E%9F%E7%90%86%EF%BC%9A%E4%BB%A3%E7%A0%81%E6%94%B9%E5%8A%A8%E5%90%8E%EF%BC%8C%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%AF%AB%E7%A7%92%E7%BA%A7%E5%88%AB%E7%9A%84%E5%B1%80%E9%83%A8%E6%9B%B4%E6%96%B0.html" class="sidebar-link">HMR API 及原理：代码改动后，如何进行毫秒级别的局部更新</a></li><li><a href="./fe-engineering-docs-vite-docs-note-13-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2%EF%BC%9A%E6%89%93%E5%8C%85%E5%AE%8C%E4%BA%A7%E7%89%A9%E4%BD%93%E7%A7%AF%E5%A4%AA%E5%A4%A7%EF%BC%8C%E6%80%8E%E4%B9%88%E6%8B%86%E5%8C%85.html" class="sidebar-link">代码分割：打包完产物体积太大，怎么拆包</a></li><li><a href="./fe-engineering-docs-vite-docs-note-14-%E8%AF%AD%E6%B3%95%E9%99%8D%E7%BA%A7%E4%B8%8EPolyfill%EF%BC%9A%E8%81%94%E5%90%88%E5%89%8D%E7%AB%AF%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E9%93%BE%EF%BC%8C%E6%B6%88%E7%81%AD%E4%BD%8E%E7%89%88%E6%9C%AC%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98.html" class="sidebar-link">语法降级与Polyfill：联合前端编译工具链，消灭低版本浏览器兼容问题</a></li><li><a href="./fe-engineering-docs-vite-docs-note-15-%E9%A2%84%E6%B8%B2%E6%9F%93%EF%BC%9A%E5%A6%82%E4%BD%95%E5%80%9F%E5%8A%A9%20Vite%20%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93(SSR)%E5%B7%A5%E7%A8%8B.html" class="sidebar-link">预渲染：如何借助 Vite 搭建高可用的服务端渲染(SSR)工程</a></li><li><a href="./fe-engineering-docs-vite-docs-note-16-%E6%A8%A1%E5%9D%97%E8%81%94%E9%82%A6:%20%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BC%98%E9%9B%85%E7%9A%84%E8%B7%A8%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%E5%85%B1%E4%BA%AB.html" class="sidebar-link">模块联邦: 如何实现优雅的跨应用代码共享</a></li><li><a href="./fe-engineering-docs-vite-docs-note-17-%E5%86%8D%E8%B0%88%20ESM%EF%BC%9A%E9%AB%98%E9%98%B6%E7%89%B9%E6%80%A7%20&amp;%20Pure%20ESM%20%E6%97%B6%E4%BB%A3.html" class="sidebar-link">再谈 ESM：高阶特性 &amp; Pure ESM 时代</a></li><li><a href="./fe-engineering-docs-vite-docs-note-18-%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96:%20%E5%A6%82%E4%BD%95%E4%BD%93%E7%B3%BB%E5%8C%96%E5%9C%B0%E5%AF%B9%20Vite%20%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html" class="sidebar-link"> 性能优化: 如何体系化地对 Vite 项目进行性能优化</a></li><li><a href="./fe-engineering-docs-vite-docs-note-19-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E6%9C%8D%E5%8A%A1%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9C%A8%20Vite%20%E5%86%85%E9%83%A8%E8%A2%AB%E8%BD%AC%E6%8D%A2%E6%88%90%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90%E4%BA%86.html" class="sidebar-link">配置解析服务：配置文件在 Vite 内部被转换成什么样子了</a></li><li><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html" class="active sidebar-link">依赖预构建：Esbuild 打包功能如何被 Vite 玩出花来</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86" class="sidebar-link">流程梳理</a></li><li class="sidebar-sub-header"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3" class="active sidebar-link">加载配置文件详解</a></li><li class="sidebar-sub-header"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E6%80%BB%E7%BB%93" class="sidebar-link">总结</a></li></ul></li><li><a href="./fe-engineering-docs-vite-docs-note-21-%E6%8F%92%E4%BB%B6%E6%B5%81%E6%B0%B4%E7%BA%BF%EF%BC%9A%E4%BB%8E%E6%95%B4%E4%BD%93%E5%88%B0%E5%B1%80%E9%83%A8%EF%BC%8C%E7%90%86%E8%A7%A3%20Vite%20%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BC%96%E8%AF%91%E8%83%BD%E5%8A%9B.html" class="sidebar-link">插件流水线：从整体到局部，理解 Vite 的核心编译能力</a></li><li><a href="./fe-engineering-docs-vite-docs-note-22-%E7%83%AD%E6%9B%B4%E6%96%B0%EF%BC%9A%E5%9F%BA%E4%BA%8E%20ESM%20%E7%9A%84%E6%AF%AB%E7%A7%92%E7%BA%A7%20HMR%20%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%8F%AD%E7%A7%98.html" class="sidebar-link">热更新：基于 ESM 的毫秒级 HMR 的实现揭秘</a></li><li><a href="./fe-engineering-docs-vite-docs-note-23-%E6%89%8B%E5%86%99%20Vite:%20%E5%AE%9E%E7%8E%B0%20no%20bundle%20%E5%BC%80%E5%8F%91%E6%9C%8D%E5%8A%A1%20%E4%B8%8A.html" class="sidebar-link">手写 Vite: 实现 no bundle 开发服务 上</a></li><li><a href="./fe-engineering-docs-vite-docs-note-24-%E6%89%8B%E5%86%99%20Vite:%20%E5%AE%9E%E7%8E%B0%20no%20bundle%20%E5%BC%80%E5%8F%91%E6%9C%8D%E5%8A%A1%20%E4%B8%8B.html" class="sidebar-link">手写 Vite: 实现 no bundle 开发服务 下</a></li><li><a href="./fe-engineering-docs-vite-docs-note-25-%E6%89%8B%E5%86%99%20Bundler:%20%E5%AE%9E%E7%8E%B0%20JavaScript%20AST%20%E8%A7%A3%E6%9E%90%E5%99%A8_%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E3%80%81%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90.html" class="sidebar-link">手写 Bundler: 实现 JavaScript AST 解析器_词法分析、语义分析</a></li><li><a href="./fe-engineering-docs-vite-docs-note-26-%E6%89%8B%E5%86%99%20Bundler:%20%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%89%93%E5%8C%85%E5%92%8CTree%20Shaking.html" class="sidebar-link">手写 Bundler: 实现代码打包和Tree Shaking</a></li></ul></section></li></ul> </aside> <main class="page"> <div id="container" class="theme-default-content"><div class="content__default"><p>我们前面学习了 Vite 的各种高级应用场景，接下来的几个小节，我们再把目光放到 Vite 的实现本身，来深度剖析 Vite 的内部源码实现。</p> <p>可能你会有一个疑问，我们为什么要去读源码？原因主要有两个：一是加深对框架本身的理解，在面对一些项目的疑难杂症时，排查问题效率会更高；二是在遇到类似的开发场景时，可以举一反三，借鉴某个框架源码的实现思路，将技巧应用到其它的项目中。</p> <p>本小节我们要介绍 Vite 配置解析服务的源码部分。我们知道，Vite 构建环境分为<code>开发环境</code>和<code>生产环境</code>，不同环境会有不同的构建策略，但不管是哪种环境，Vite 都会首先解析用户配置。那接下来，我就与你分析配置解析过程中 Vite 到底做了什么。</p> <p>首先，我会带你梳理整体的实现流程，然后拆解其中的重点细节，即<code>如何加载配置文件</code>，让你不仅对 Vite 的配置解析服务有系统且完整的认识，还能写一个自己的<code>配置文件加载器</code>。</p> <h2 id="流程梳理"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86" class="header-anchor">#</a> 流程梳理</h2> <p>我们先来梳理整体的流程，Vite 中的配置解析由 <a href="https://github.com/vitejs/vite/blob/main/packages/vite/src/node/config.ts#L255" target="_blank" rel="noopener noreferrer">resolveConfig<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数来实现，你可以对照源码一起学习。</p> <h3 id="_1-加载配置文件"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_1-%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" class="header-anchor">#</a> 1. 加载配置文件</h3> <p>进行一些必要的变量声明后，我们进入到<strong>解析配置</strong>逻辑中:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// 这里的 config 是命令行指定的配置，如 vite --configFile=xxx</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span> configFile <span class="token punctuation">}</span> <span class="token operator">=</span> config
<span class="token keyword">if</span> <span class="token punctuation">(</span>configFile <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 默认都会走到下面加载配置文件的逻辑，除非你手动指定 configFile 为 false</span>
  <span class="token keyword">const</span> loadResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromFile</span><span class="token punctuation">(</span>
    configEnv<span class="token punctuation">,</span>
    configFile<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>root<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>logLevel
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析配置文件的内容后，和命令行配置合并</span>
    config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>loadResult<span class="token punctuation">.</span>config<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    configFile <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>path
    configFileDependencies <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>dependencies
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>第一步是解析配置文件的内容(这部分比较复杂，本文后续单独分析)，然后与命令行配置合并。值得注意的是，后面有一个记录<code>configFileDependencies</code>的操作。因为配置文件代码可能会有第三方库的依赖，所以当第三方库依赖的代码更改时，Vite 可以通过 HMR 处理逻辑中记录的<code>configFileDependencies</code>检测到更改，再重启 DevServer ，来保证当前生效的配置永远是最新的。</p> <h3 id="_2-解析用户插件"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_2-%E8%A7%A3%E6%9E%90%E7%94%A8%E6%88%B7%E6%8F%92%E4%BB%B6" class="header-anchor">#</a> 2. 解析用户插件</h3> <p>第二个重点环节是 <strong>解析用户插件</strong>。首先，我们通过 <code>apply 参数</code> 过滤出需要生效的用户插件。为什么这么做呢？因为有些插件只在开发阶段生效，或者说只在生产环境生效，我们可以通过 <code>apply: 'serve' 或 'build'</code> 来指定它们，同时也可以将<code>apply</code>配置为一个函数，来自定义插件生效的条件。解析代码如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// resolve plugins</span>
<span class="token keyword">const</span> rawUserPlugins <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">.</span>apply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> p<span class="token punctuation">.</span>apply <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// apply 为一个函数的情况</span>
    <span class="token keyword">return</span> <span class="token function">p</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>config<span class="token punctuation">,</span> mode <span class="token punctuation">}</span><span class="token punctuation">,</span> configEnv<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>apply <span class="token operator">===</span> command
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 对用户插件进行排序</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>prePlugins<span class="token punctuation">,</span> normalPlugins<span class="token punctuation">,</span> postPlugins<span class="token punctuation">]</span> <span class="token operator">=</span>
  <span class="token function">sortUserPlugins</span><span class="token punctuation">(</span>rawUserPlugins<span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>接着，Vite 会拿到这些过滤且排序完成的插件，依次调用插件 config 钩子，进行配置合并:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// run config hooks</span>
<span class="token keyword">const</span> userPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>prePlugins<span class="token punctuation">,</span> <span class="token operator">...</span>normalPlugins<span class="token punctuation">,</span> <span class="token operator">...</span>postPlugins<span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> userPlugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> p<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> configEnv<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// mergeConfig 为具体的配置合并函数，大家有兴趣可以阅读一下实现</span>
      config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>然后解析项目的根目录即 <code>root</code> 参数，默认取 <code>process.cwd()</code>的结果:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// resolve root</span>
<span class="token keyword">const</span> resolvedRoot <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>
  config<span class="token punctuation">.</span>root <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>紧接着处理 <code>alias</code> ，这里需要加上一些内置的 alias 规则，如<code>@vite/env</code>、<code>@vite/client</code>这种直接重定向到 Vite 内部的模块:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// resolve alias with internal client alias</span>
<span class="token keyword">const</span> resolvedAlias <span class="token operator">=</span> <span class="token function">mergeAlias</span><span class="token punctuation">(</span>
  clientAlias<span class="token punctuation">,</span>
  config<span class="token punctuation">.</span>resolve<span class="token operator">?</span><span class="token punctuation">.</span>alias <span class="token operator">||</span> config<span class="token punctuation">.</span>alias <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> resolveOptions<span class="token punctuation">:</span> ResolvedConfig<span class="token punctuation">[</span><span class="token string">'resolve'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  dedupe<span class="token punctuation">:</span> config<span class="token punctuation">.</span>dedupe<span class="token punctuation">,</span>
  <span class="token operator">...</span>config<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span>
  alias<span class="token punctuation">:</span> resolvedAlias
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><h3 id="_3-加载环境变量"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_3-%E5%8A%A0%E8%BD%BD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" class="header-anchor">#</a> 3. 加载环境变量</h3> <p>现在，我们进入第三个核心环节: <strong>加载环境变量</strong>，它的实现代码如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// load .env files</span>
<span class="token keyword">const</span> envDir <span class="token operator">=</span> config<span class="token punctuation">.</span>envDir
  <span class="token operator">?</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>resolvedRoot<span class="token punctuation">,</span> config<span class="token punctuation">.</span>envDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span> resolvedRoot
<span class="token keyword">const</span> userEnv <span class="token operator">=</span>
  inlineConfig<span class="token punctuation">.</span>envFile <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span>
  <span class="token function">loadEnv</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> envDir<span class="token punctuation">,</span> <span class="token function">resolveEnvPrefix</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>loadEnv 其实就是扫描 <code>process.env</code> 与 <code>.env</code>文件，解析出 env 对象，值得注意的是，这个对象的属性最终会被挂载到<code>import.meta.env</code> 这个全局对象上。</p> <p>解析 env 对象的实现思路如下:</p> <ul><li>遍历 process.env 的属性，拿到<strong>指定前缀</strong>开头的属性（默认指定为<code>VITE_</code>），并挂载 env 对象上</li> <li>遍历 .env 文件，解析文件，然后往 env 对象挂载那些以<strong>指定前缀</strong>开头的属性。遍历的文件先后顺序如下(下面的 <code>mode</code> 开发阶段为 <code>development</code>，生产环境为<code>production</code>):
<ul><li><code>.env.${mode}.local</code></li> <li><code>.env.${mode}</code></li> <li><code>.env.local</code></li> <li><code>.env</code></li></ul></li></ul> <blockquote><p>特殊情况: 如果中途遇到 NODE_ENV 属性，则挂到 <code>process.env.VITE_USER_NODE_ENV</code>，Vite 会优先通过这个属性来决定是否走<code>生产环境</code>的构建。</p></blockquote> <p>接下来是对资源公共路径即<code>base URL</code>的处理，逻辑集中在 resolveBaseUrl 函数当中:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// 解析 base url</span>
<span class="token keyword">const</span> <span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token function">resolveBaseUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>base<span class="token punctuation">,</span> command <span class="token operator">===</span> <span class="token string">'build'</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
<span class="token comment">// 解析生产环境构建配置</span>
<span class="token keyword">const</span> resolvedBuildOptions <span class="token operator">=</span> <span class="token function">resolveBuildOptions</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p><code>resolveBaseUrl</code>里面有这些处理规则需要注意:</p> <ul><li>空字符或者 <code>./</code> 在开发阶段特殊处理，全部重写为<code>/</code></li> <li><code>.</code>开头的路径，自动重写为 <code>/</code></li> <li>以<code>http(s)://</code>开头的路径，在开发环境下重写为对应的 pathname</li> <li>确保路径开头和结尾都是<code>/</code></li></ul> <p>当然，还有对<code>cacheDir</code>的解析，这个路径相对于在 Vite 预编译时写入依赖产物的路径:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// resolve cache directory</span>
<span class="token keyword">const</span> pkgPath <span class="token operator">=</span> <span class="token function">lookupFile</span><span class="token punctuation">(</span>resolvedRoot<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* pathOnly */</span><span class="token punctuation">)</span>
<span class="token comment">// 默认为 node_module/.vite</span>
<span class="token keyword">const</span> cacheDir <span class="token operator">=</span> config<span class="token punctuation">.</span>cacheDir
  <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>resolvedRoot<span class="token punctuation">,</span> config<span class="token punctuation">.</span>cacheDir<span class="token punctuation">)</span>
  <span class="token punctuation">:</span> pkgPath <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.vite</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>紧接着处理用户配置的<code>assetsInclude</code>，将其转换为一个过滤器函数:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> assetsFilter <span class="token operator">=</span> config<span class="token punctuation">.</span>assetsInclude
  <span class="token operator">?</span> <span class="token function">createFilter</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>assetsInclude<span class="token punctuation">)</span>
  <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>Vite 后面会将用户传入的 assetsInclude 和内置的规则合并:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token function">assetsInclude</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">DEFAULT_ASSETS_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">assetsFilter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>这个配置决定是否让 Vite 将对应的后缀名视为<code>静态资源文件</code>（asset）来处理。</p> <h3 id="_4-路径解析器工厂"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_4-%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E5%99%A8%E5%B7%A5%E5%8E%82" class="header-anchor">#</a> 4. 路径解析器工厂</h3> <p>接下来，进入到第四个核心环节: <strong>定义路径解析器工厂</strong>。这里所说的<code>路径解析器</code>，是指调用插件容器进行<code>路径解析</code>的函数。代码结构是这个样子的:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> createResolver<span class="token punctuation">:</span> ResolvedConfig<span class="token punctuation">[</span><span class="token string">'createResolver'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> aliasContainer<span class="token punctuation">:</span> PluginContainer <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token keyword">let</span> resolverContainer<span class="token punctuation">:</span> PluginContainer <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token comment">// 返回的函数可以理解为一个解析器</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> aliasOnly<span class="token punctuation">,</span> ssr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> container<span class="token punctuation">:</span> PluginContainer
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aliasOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      container <span class="token operator">=</span>
        aliasContainer <span class="token operator">||</span>
        <span class="token comment">// 新建 aliasContainer</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      container <span class="token operator">=</span>
        resolverContainer <span class="token operator">||</span>
        <span class="token comment">// 新建 resolveContainer</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> ssr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>id
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>这个解析器未来会在<strong>依赖预构建</strong>的时候用上，具体用法如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> resolve <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">createResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 调用以拿到 react 路径</span>
<span class="token function">rseolve</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>这里有<code>aliasContainer</code>和<code>resolverContainer</code>两个工具对象，它们都含有<code>resolveId</code>这个专门解析路径的方法，可以被 Vite 调用来获取解析结果。</p> <blockquote><p>两个工具对象的本质是<code>PluginContainer</code>，我们将在「编译流水线」小节详细介绍<code>PluginContainer</code> 的特点和实现。</p></blockquote> <p>接着会顺便处理一个 public 目录，也就是 Vite 作为静态资源服务的目录:</p> <div class="language-ts extra-class"><pre class="language-ts code-copy-added"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> publicDir <span class="token punctuation">}</span> <span class="token operator">=</span> config
<span class="token keyword">const</span> resolvedPublicDir <span class="token operator">=</span>
  publicDir <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> publicDir <span class="token operator">!==</span> <span class="token string">''</span>
    <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
        resolvedRoot<span class="token punctuation">,</span>
        <span class="token keyword">typeof</span> publicDir <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> publicDir <span class="token punctuation">:</span> <span class="token string">'public'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token string">''</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>至此，配置已经基本上解析完成，最后通过 resolved 对象来整理一下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> resolved<span class="token punctuation">:</span> ResolvedConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>config<span class="token punctuation">,</span>
  configFile<span class="token punctuation">:</span> configFile <span class="token operator">?</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  configFileDependencies<span class="token punctuation">,</span>
  inlineConfig<span class="token punctuation">,</span>
  root<span class="token punctuation">:</span> resolvedRoot<span class="token punctuation">,</span>
  base<span class="token punctuation">:</span> <span class="token constant">BASE_URL</span>
  <span class="token comment">// 其余配置不再一一列举</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><h3 id="_5-生成插件流水线"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_5-%E7%94%9F%E6%88%90%E6%8F%92%E4%BB%B6%E6%B5%81%E6%B0%B4%E7%BA%BF" class="header-anchor">#</a> 5. 生成插件流水线</h3> <p>最后，我们进入第五个环节: <strong>生成插件流水线</strong>。代码如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token punctuation">;</span><span class="token punctuation">(</span>resolved<span class="token punctuation">.</span>plugins <span class="token keyword">as</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span>
  resolved<span class="token punctuation">,</span>
  prePlugins<span class="token punctuation">,</span>
  normalPlugins<span class="token punctuation">,</span>
  postPlugins
<span class="token punctuation">)</span>

<span class="token comment">// call configResolved hooks</span>
<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>userPlugins<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>configResolved<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>先生成完整插件列表传给<code>resolve.plugins</code>，而后调用每个插件的 <code>configResolved</code> 钩子函数。其中 <code>resolvePlugins</code> 内部细节比较多，插件数量比较庞大，我们暂时不去深究具体实现，编译流水线这一小节再来详细介绍。</p> <p>至此，所有核心配置都生成完毕。不过，后面 Vite 还会处理一些边界情况，在用户配置不合理的时候，给用户对应的提示。比如：用户直接使用<code>alias</code>时，Vite 会提示使用<code>resolve.alias</code>。</p> <p>最后，<code>resolveConfig</code> 函数会返回 resolved 对象，也就是最后的配置集合，那么配置解析服务到底也就结束了。</p> <h2 id="加载配置文件详解"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3" class="header-anchor">#</a> 加载配置文件详解</h2> <p>配置解析服务的流程梳理完，但刚开始<code>加载配置文件(loadConfigFromFile)</code>的实现我们还没有具体分析，先来回顾下代码。</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> loadResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromFile</span><span class="token punctuation">(</span><span class="token comment">/*省略传参*/</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>这里的逻辑稍微有点复杂，很难梳理清楚，所以我们不妨借助刚才梳理的配置解析流程，深入<code>loadConfigFromFile</code> 的细节中，研究下 Vite 对于配置文件加载的实现思路。</p> <p>首先，我们来分析下需要处理的配置文件类型，根据<code>文件后缀</code>和<code>模块格式</code>可以分为下面这几类:</p> <ul><li>TS + ESM 格式</li> <li>TS + CommonJS 格式</li> <li>JS + ESM 格式</li> <li>JS + CommonJS 格式</li></ul> <p>那么，Vite 是如何加载配置文件的？一共分两个步骤:</p> <ol><li>识别出配置文件的类别</li> <li>根据不同的类别分别解析出配置内容</li></ol> <h3 id="_1-识别配置文件的类别"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_1-%E8%AF%86%E5%88%AB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%B1%BB%E5%88%AB" class="header-anchor">#</a> 1. 识别配置文件的类别</h3> <p>首先 Vite 会检查项目的 package.json ，如果有<code>type: "module"</code>则打上 <code>isESM</code> 的标识:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">lookupFile</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">&amp;&amp;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'module'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isMjs <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>然后，Vite 会寻找配置文件路径，代码简化后如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">let</span> isTS <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> isESM <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> dependencies<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 如果命令行有指定配置文件路径</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>configFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  resolvedPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span>
  <span class="token comment">// 根据后缀判断是否为 ts 或者 esm，打上 flag</span>
  isTS <span class="token operator">=</span> configFile<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.ts'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>configFile<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.mjs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isESM <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从项目根目录寻找配置文件路径，寻找顺序:</span>
  <span class="token comment">// - vite.config.js</span>
  <span class="token comment">// - vite.config.mjs</span>
  <span class="token comment">// - vite.config.ts</span>
  <span class="token comment">// - vite.config.cjs</span>
  <span class="token keyword">const</span> jsconfigFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token string">'vite.config.js'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>jsconfigFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolvedPath <span class="token operator">=</span> jsconfigFile
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mjsconfigFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token string">'vite.config.mjs'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>mjsconfigFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolvedPath <span class="token operator">=</span> mjsconfigFile
      isESM <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tsconfigFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token string">'vite.config.ts'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>tsconfigFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolvedPath <span class="token operator">=</span> tsconfigFile
      isTS <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cjsConfigFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token string">'vite.config.cjs'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>cjsConfigFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolvedPath <span class="token operator">=</span> cjsConfigFile
      isESM <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>在寻找路径的同时， Vite 也会给当前配置文件打上<code>isESM</code>和<code>isTS</code>的标识，方便后续的解析。</p> <h3 id="_2-根据类别解析配置"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#_2-%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%88%AB%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE" class="header-anchor">#</a> 2. 根据类别解析配置</h3> <h4 id="esm-格式"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#esm-%E6%A0%BC%E5%BC%8F" class="header-anchor">#</a> ESM 格式</h4> <p>对于 ESM 格式配置的处理代码如下：</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">let</span> userConfig<span class="token punctuation">:</span> UserConfigExport <span class="token operator">|</span> <span class="token keyword">undefined</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isESM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileUrl <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pathToFileURL</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span>
  <span class="token comment">// 首先对代码进行打包</span>
  <span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies
  <span class="token comment">// TS + ESM</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
    userConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dynamicImport</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>default
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TS + native esm config loaded in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> fileUrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
  <span class="token comment">//  JS + ESM</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    userConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dynamicImport</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">native esm config loaded in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> fileUrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>首先通过 Esbuild 将配置文件编译打包成 js 代码:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 记录依赖</span>
dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>对于 TS 配置文件来说，Vite 会将编译后的 js 代码写入<code>临时文件</code>，通过 Node 原生 ESM Import 来读取这个临时的内容，以获取到配置内容，再直接删掉临时文件:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
userConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">dynamicImport</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><blockquote><p>以上这种先编译配置文件，再将产物写入临时目录，最后加载临时目录产物的做法，也是 AOT (Ahead Of Time)编译技术的一种具体实现。</p></blockquote> <p>而对于 JS 配置文件来说，Vite 会直接通过 Node 原生 ESM Import 来读取，也是使用 dynamicImport 函数的逻辑。<code>dynamicImport</code> 的实现如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">export</span> <span class="token keyword">const</span> dynamicImport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'return import(file)'</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>你可能会问，为什么要用 new Function 包裹？这是为了避免打包工具处理这段代码，比如 <code>Rollup</code> 和 <code>TSC</code>，类似的手段还有 <code>eval</code>。</p> <p>你可能还会问，为什么 import 路径结果要加上时间戳 query？这其实是为了让 dev server 重启后仍然读取最新的配置，避免缓存。</p> <h3 id="commonjs-格式"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#commonjs-%E6%A0%BC%E5%BC%8F" class="header-anchor">#</a> CommonJS 格式</h3> <p>对于 CommonJS 格式的配置文件，Vite 集中进行了解析:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// 对于 js/ts 均生效</span>
<span class="token comment">// 使用 esbuild 将配置文件编译成 commonjs 格式的 bundle 文件</span>
<span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span>
dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies
<span class="token comment">// 加载编译后的 bundle 代码</span>
userConfig <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p><code>bundleConfigFile</code> 的逻辑上文中已经说了，主要是通过 Esbuild 将配置文件打包，拿到打包后的 bundle 代码以及配置文件的依赖(dependencies)。</p> <p>而接下来的事情就是考虑如何加载 bundle 代码了，这也是<code>loadConfigFromBundledFile</code> 要做的事情。我们来看一下这个函数具体的实现:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span>
  <span class="token parameter">fileName<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  bundledCode<span class="token punctuation">:</span> string</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>UserConfig<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> extension <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
  <span class="token keyword">const</span> defaultLoader <span class="token operator">=</span> require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token operator">!</span>
  require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">:</span> NodeModule<span class="token punctuation">,</span> filename<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">===</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span>module <span class="token keyword">as</span> NodeModuleWithCompile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>bundledCode<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">defaultLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 清除 require 缓存</span>
  <span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> raw<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> raw<span class="token punctuation">.</span>default <span class="token punctuation">:</span> raw
  require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> defaultLoader
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>大体的思路是通过拦截原生 require.extensions 的加载函数来实现对 bundle 后配置代码的加载。代码如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// 默认加载器</span>
<span class="token keyword">const</span> defaultLoader <span class="token operator">=</span> require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token operator">!</span>
<span class="token comment">// 拦截原生 require 对于`.js`或者`.ts`的加载</span>
require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">:</span> NodeModule<span class="token punctuation">,</span> filename<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 针对 vite 配置文件的加载特殊处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">===</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">;</span><span class="token punctuation">(</span>module <span class="token keyword">as</span> NodeModuleWithCompile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>bundledCode<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">defaultLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>而原生 require 对于 js 文件的加载代码是这样的:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>Node.js 内部也是先读取文件内容，然后编译该模块。当代码中调用 <code>module._compile</code> 相当于手动编译一个模块，该方法在 Node 内部的实现如下:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">]</span>
  <span class="token keyword">return</span> <span class="token function">compiledWrapper</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>等同于下面的形式:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行 module._compile 方法中传入的代码</span>
  <span class="token comment">// 返回 exports 对象</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><p>在调用完 <code>module._compile</code> 编译完配置代码后，进行一次手动的 require，即可拿到配置对象:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> raw<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> raw<span class="token punctuation">.</span>default <span class="token punctuation">:</span> raw
<span class="token comment">// 恢复原生的加载方法</span>
require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> defaultLoader
<span class="token comment">// 返回配置</span>
<span class="token keyword">return</span> config
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><blockquote><p>这种运行时加载 TS 配置的方式，也叫做 <code>JIT</code>(即时编译)，这种方式和 <code>AOT</code> 最大的区别在于不会将内存中计算出来的 js 代码写入磁盘再加载，而是通过拦截 Node.js 原生 require.extension 方法实现即时加载。</p></blockquote> <p>至此，配置文件的内容已经读取完成，等后处理完成再返回即可:</p> <div class="language-js extra-class"><pre class="language-js code-copy-added"><code><span class="token comment">// 处理是函数的情况</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> userConfig <span class="token operator">===</span> <span class="token string">'function'</span>
  <span class="token operator">?</span> <span class="token function">userConfig</span><span class="token punctuation">(</span>configEnv<span class="token punctuation">)</span>
  <span class="token punctuation">:</span> userConfig<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">config must export or return an object.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 接下来返回最终的配置信息</span>
<span class="token keyword">return</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
  config<span class="token punctuation">,</span>
  <span class="token comment">// esbuild 打包过程中搜集的依赖</span>
  dependencies
<span class="token punctuation">}</span>
</code><div data-v-49140617 class="code-copy"><svg data-v-49140617 xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover" style="bottom:7.5px"><path data-v-49140617 fill="none" d="M0 0h24v24H0z"></path> <path data-v-49140617 fill="#3eaf7c" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"></path></svg> <span data-v-49140617 class style="bottom:7.5px">
        @程序员poetry: 代码已经复制到剪贴板
    </span></div></pre></div><h2 id="总结"><a href="./fe-engineering-docs-vite-docs-note-20-%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA%EF%BC%9AEsbuild%20%E6%89%93%E5%8C%85%E5%8A%9F%E8%83%BD%E5%A6%82%E4%BD%95%E8%A2%AB%20Vite%20%E7%8E%A9%E5%87%BA%E8%8A%B1%E6%9D%A5.html#%E6%80%BB%E7%BB%93" class="header-anchor">#</a> 总结</h2> <p>配置解析的源码精读部分到这里就结束了，再次恭喜你，学习完了本小节的内容。本小节中，你需要重点掌握<code>Vite 配置解析的整体流程</code>和<code>加载配置文件的方法</code>。</p> <p>首先，Vite 配置文件解析的逻辑由 <code>resolveConfig</code> 函数统一实现，其中经历了加载配置文件、解析用户插件、加载环境变量、创建路径解析器工厂和生成插件流水线这几个主要的流程。</p> <p>其次，在<code>加载配置文件</code>的过程中，Vite 需要处理四种类型的配置文件，其中对于 ESM 和 CommonJS 两种格式的 TS 文件，分别采用了<code>AOT</code>和<code>JIT</code>两种编译技术实现了配置加载</p></div> <!----> <!----></div>  <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="./fe-engineering-docs-vite-docs-note-19-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E6%9C%8D%E5%8A%A1%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9C%A8%20Vite%20%E5%86%85%E9%83%A8%E8%A2%AB%E8%BD%AC%E6%8D%A2%E6%88%90%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90%E4%BA%86.html" class="prev">配置解析服务：配置文件在 Vite 内部被转换成什么样子了</a></span> <span class="next"><a href="./fe-engineering-docs-vite-docs-note-21-%E6%8F%92%E4%BB%B6%E6%B5%81%E6%B0%B4%E7%BA%BF%EF%BC%9A%E4%BB%8E%E6%95%B4%E4%BD%93%E5%88%B0%E5%B1%80%E9%83%A8%EF%BC%8C%E7%90%86%E8%A7%A3%20Vite%20%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BC%96%E8%AF%91%E8%83%BD%E5%8A%9B.html" class>插件流水线：从整体到局部，理解 Vite 的核心编译能力</a>
      →
    </span></p></div>  </main> <div class="el-dialog__wrapper" style="display:none"></div> <div class="el-dialog__wrapper" style="display:none"></div> <div class="el-dialog__wrapper" style="display:none"></div> <div class="el-dialog__wrapper" style="display:none"></div></div><div class="global-ui"><!----></div></div>
    
  

</body></html>